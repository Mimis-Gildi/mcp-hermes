# Gmail MCP Server -- Google Contacts (People API) Setup

**For:** Vadim, Anton, Claude
**Last verified:** 2026-02-12

---

## What This Is

The Gmail MCP server (`~/.mcp-servers/gmail/`) provides Claude Code with Gmail + Google Contacts access.
It's a third-party server (`GongRzhe/Gmail-MCP-Server`) with **local modifications** for contacts support.

## Architecture

```
~/.mcp-servers/gmail/
├── src/index.ts          ← Source (TypeScript). WE MODIFIED THIS.
├── dist/index.js         ← Compiled. Generated by `npm run build`.
├── package.json          ← Dependencies
└── CONTACTS-SETUP.md     ← This file

~/.gmail-mcp/
├── vadim/
│   ├── gcp-oauth.keys.json   ← GCP OAuth client credentials (from GCP Console)
│   └── credentials.json      ← OAuth tokens (access + refresh). Auto-refreshes.
└── aseix/
    ├── gcp-oauth.keys.json
    └── credentials.json

~/.claude/settings.json        ← MCP server config (tells Claude Code how to launch)
```

## GCP Project

- **Project ID:** `regal-cairn-486602-h4`
- **Console:** https://console.cloud.google.com/apis/credentials?project=regal-cairn-486602-h4
- **Consent screen:** https://console.cloud.google.com/apis/credentials/consent?project=regal-cairn-486602-h4
- **Enabled APIs:** Gmail API, People API
- **OAuth scopes:** `gmail.modify`, `gmail.settings.basic`, `contacts`

## Our Local Modifications

The upstream repo does NOT include People API tools. We added:

### 1. OAuth scope (line ~153 in src/index.ts)

Added `'https://www.googleapis.com/auth/contacts'` to the scope array in `authenticate()`.

### 2. Three People API tools

| Tool | Purpose | People API Method |
|------|---------|-------------------|
| `search_contacts` | Search by name/email/phone | `people.searchContacts` |
| `list_contacts` | Paginated list of all contacts | `people.connections.list` |
| `get_contact` | Full detail for one contact | `people.get` |

### 3. People API client init

```typescript
const people = google.people({ version: 'v1', auth: oauth2Client });
```

Uses the same `oauth2Client` as Gmail -- no separate auth needed.

---

## How to Rebuild After Changes

```bash
cd ~/.mcp-servers/gmail
npm run build
```

Then restart Claude Code (or `/mcp` to reconnect MCP servers).

## How to Re-Authenticate (Token Expired)

**Symptoms:** Tools return auth errors, 401/403 responses.

**Why it happens:** GCP app is in **Testing** mode. Refresh tokens expire after 7 days.
To fix permanently: move app to Production in GCP Console (Consent Screen → Publish).

**Quick fix -- re-auth:**

```bash
cd ~/.mcp-servers/gmail
node dist/index.js auth
```

This opens a browser for OAuth. Approve the scopes. New tokens saved to `~/.gmail-mcp/<account>/credentials.json`.

**For a specific account** (vadim vs aseix), set env vars first:

```bash
# Vadim's personal Gmail
GMAIL_OAUTH_PATH=~/.gmail-mcp/vadim/gcp-oauth.keys.json \
GMAIL_CREDENTIALS_PATH=~/.gmail-mcp/vadim/credentials.json \
node dist/index.js auth

# ASE work Gmail
GMAIL_OAUTH_PATH=~/.gmail-mcp/aseix/gcp-oauth.keys.json \
GMAIL_CREDENTIALS_PATH=~/.gmail-mcp/aseix/credentials.json \
node dist/index.js auth
```

## How to Check Token Status

```bash
cat ~/.gmail-mcp/vadim/credentials.json | python3 -c "
import json, sys, datetime
d = json.load(sys.stdin)
exp = datetime.datetime.fromtimestamp(d['expiry_date']/1000)
print(f'Access token expires: {exp}')
print(f'Scopes: {d[\"scope\"]}')
print(f'Has refresh token: {\"refresh_token\" in d}')
"
```

## WARNING: Do Not `git pull` Without Saving Changes

The upstream repo does NOT have our People API tools. A `git pull` will overwrite `src/index.ts` and destroy our additions.

**Before pulling upstream updates:**

```bash
cd ~/.mcp-servers/gmail
git stash                  # Save our changes
git pull                   # Get upstream
git stash pop              # Re-apply our changes
npm run build              # Rebuild
```

**Or better:** Keep a patch file:

```bash
cd ~/.mcp-servers/gmail
git diff > ~/contacts-tools.patch    # Save once

# After pull:
git apply ~/contacts-tools.patch     # Re-apply
npm run build
```

---

## Claude Code MCP Config Reference

In `~/.claude/settings.json`:

```json
{
  "mcpServers": {
    "gmail-vadim": {
      "command": "node",
      "args": ["/Users/rdd13r/.mcp-servers/gmail/dist/index.js"],
      "env": {
        "GMAIL_OAUTH_PATH": "/Users/rdd13r/.gmail-mcp/vadim/gcp-oauth.keys.json",
        "GMAIL_CREDENTIALS_PATH": "/Users/rdd13r/.gmail-mcp/vadim/credentials.json"
      }
    },
    "gmail-aseix": {
      "command": "node",
      "args": ["/Users/rdd13r/.mcp-servers/gmail/dist/index.js"],
      "env": {
        "GMAIL_OAUTH_PATH": "/Users/rdd13r/.gmail-mcp/aseix/gcp-oauth.keys.json",
        "GMAIL_CREDENTIALS_PATH": "/Users/rdd13r/.gmail-mcp/aseix/credentials.json"
      }
    }
  }
}
```

Both servers use the **same binary** (`dist/index.js`), just different credentials.

---

## Tools Available After Setup

### Gmail Tools (upstream)
`send_email`, `draft_email`, `read_email`, `search_emails`, `modify_email`, `delete_email`,
`list_email_labels`, `batch_modify_emails`, `batch_delete_emails`, `create_label`, `update_label`,
`delete_label`, `get_or_create_label`, `create_filter`, `list_filters`, `get_filter`, `delete_filter`,
`create_filter_from_template`, `download_attachment`

### People API Tools (our addition)
`search_contacts`, `list_contacts`, `get_contact`

### Usage in Claude Code

```
# Search for a contact by name
mcp__gmail-vadim__search_contacts  query="Matt Hicks"

# List all contacts (paginated)
mcp__gmail-vadim__list_contacts  pageSize=50

# Get full detail for a specific contact
mcp__gmail-vadim__get_contact  resourceName="people/c1234567890"
```
